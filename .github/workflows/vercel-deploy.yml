name: Vercel Deployment (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (preview or production)'
        required: true
        type: string
        default: 'preview'
      project-name:
        description: 'Vercel project name (for notifications)'
        required: true
        type: string
      max-retries:
        description: 'Maximum retry attempts'
        required: false
        type: number
        default: 3
    secrets:
      VERCEL_TOKEN:
        required: true
      VERCEL_ORG_ID:
        required: true
      VERCEL_PROJECT_ID:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      deployment-url: ${{ steps.deploy.outputs.url }}
      deployment-status: ${{ steps.deploy.outputs.status }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Install Vercel CLI
        run: npm install -g vercel@latest
      
      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=${{ inputs.environment }} --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: Build Project
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          else
            vercel build --token=${{ secrets.VERCEL_TOKEN }}
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: Deploy to Vercel (with retry)
        id: deploy
        run: |
          MAX_RETRIES=${{ inputs.max-retries }}
          RETRY_COUNT=0
          DEPLOY_SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$DEPLOY_SUCCESS" = "false" ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Deployment attempt $RETRY_COUNT of $MAX_RETRIES"
            
            if [ "${{ inputs.environment }}" = "production" ]; then
              DEPLOY_OUTPUT=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }} 2>&1) || true
            else
              DEPLOY_OUTPUT=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} 2>&1) || true
            fi
            
            # Check if deployment succeeded (output contains URL)
            if echo "$DEPLOY_OUTPUT" | grep -q "https://"; then
              DEPLOY_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[^ ]*' | head -1)
              echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT
              echo "status=success" >> $GITHUB_OUTPUT
              echo "retries=$RETRY_COUNT" >> $GITHUB_OUTPUT
              DEPLOY_SUCCESS=true
              echo "‚úÖ Deployment successful: $DEPLOY_URL"
            else
              echo "‚ö†Ô∏è Deployment attempt $RETRY_COUNT failed. Waiting 30 seconds..."
              echo "$DEPLOY_OUTPUT"
              sleep 30
            fi
          done
          
          if [ "$DEPLOY_SUCCESS" = "false" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "retries=$RETRY_COUNT" >> $GITHUB_OUTPUT
            echo "‚ùå All deployment attempts failed"
            exit 1
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: Comment on Commit
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.deploy.outputs.status }}';
            const url = '${{ steps.deploy.outputs.url }}';
            const retries = '${{ steps.deploy.outputs.retries }}';
            const env = '${{ inputs.environment }}';
            const projectName = '${{ inputs.project-name }}';
            
            let body;
            if (status === 'success') {
              const emoji = env === 'production' ? 'üöÄ' : 'üëÄ';
              body = `${emoji} **${projectName}** deployed via GitHub Actions\n\n` +
                     `**Environment:** ${env}\n` +
                     `**URL:** ${url}\n` +
                     `**Attempts:** ${retries}`;
            } else {
              body = `‚ùå **${projectName}** deployment failed after ${retries} attempts.\n\n` +
                     `Check [workflow logs](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}) for details.`;
            }
            
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: body
            });
